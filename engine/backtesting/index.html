<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Backtesting · PingPong.jl</title><meta name="title" content="Backtesting · PingPong.jl"/><meta property="og:title" content="Backtesting · PingPong.jl"/><meta property="twitter:title" content="Backtesting · PingPong.jl"/><meta name="description" content="Documentation for PingPong.jl."/><meta property="og:description" content="Documentation for PingPong.jl."/><meta property="twitter:description" content="Documentation for PingPong.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../presentation/"><img src="../../assets/logo.png" alt="PingPong.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../presentation/">Why PingPong?</a></li><li><a class="tocitem" href="../../">What is PingPong?</a></li></ul></li><li><a class="tocitem" href="../../types/">Types</a></li><li><a class="tocitem" href="../../strategy/">Strategies</a></li><li><span class="tocitem">Engine</span><ul><li><a class="tocitem" href="../engine/">Executors</a></li><li class="is-active"><a class="tocitem" href>Backtesting</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li class="toplevel"><a class="tocitem" href="#Orders"><span>Orders</span></a></li><li><a class="tocitem" href="#Limit-Order-Types"><span>Limit Order Types</span></a></li><li><a class="tocitem" href="#Market-Order-Types"><span>Market Order Types</span></a></li><li><a class="tocitem" href="#Market-Orders"><span>Market Orders</span></a></li><li><a class="tocitem" href="#Checks"><span>Checks</span></a></li><li><a class="tocitem" href="#Fees"><span>Fees</span></a></li><li><a class="tocitem" href="#Slippage"><span>Slippage</span></a></li><li><a class="tocitem" href="#Liquidations"><span>Liquidations</span></a></li><li><a class="tocitem" href="#Backtesting-Performance"><span>Backtesting Performance</span></a></li></ul></li><li><a class="tocitem" href="../paper/">Paper</a></li><li><a class="tocitem" href="../live/">Live</a></li><li><a class="tocitem" href="../features/">Features</a></li></ul></li><li><a class="tocitem" href="../../exchanges/">Exchanges</a></li><li><a class="tocitem" href="../../data/">Data</a></li><li><span class="tocitem">Watchers</span><ul><li><a class="tocitem" href="../../watchers/watchers/">Interface</a></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Apis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../watchers/apis/coingecko/">CoinGecko</a></li><li><a class="tocitem" href="../../watchers/apis/coinpaprika/">CoinPaprika</a></li><li><a class="tocitem" href="../../watchers/apis/coinmarketcap/">CoinMarketCap</a></li></ul></li></ul></li><li><a class="tocitem" href="../../stats/">Stats</a></li><li><a class="tocitem" href="../../optimization/">Optimization</a></li><li><a class="tocitem" href="../../plotting/">Plotting</a></li><li><span class="tocitem">Misc</span><ul><li><a class="tocitem" href="../../config/">Config</a></li><li><a class="tocitem" href="../../disambiguation/">Disambiguation (Glossary)</a></li><li><a class="tocitem" href="../../troubleshooting/">Troubleshooting</a></li><li><a class="tocitem" href="../../devdocs/">Devdocs</a></li><li><a class="tocitem" href="../../contacts/">Contacts</a></li></ul></li><li><span class="tocitem">Customizations</span><ul><li><a class="tocitem" href="../../customizations/customizations/">Overview</a></li><li><a class="tocitem" href="../../customizations/orders/">Orders</a></li><li><a class="tocitem" href="../../customizations/backtest/">Backtester</a></li><li><a class="tocitem" href="../../customizations/exchanges/">Exchanges</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../API/collections/">Collections</a></li><li><a class="tocitem" href="../../API/data/">Data</a></li><li><a class="tocitem" href="../../API/ccxt/">Ccxt</a></li><li><a class="tocitem" href="../../API/dfutils/">DataFrame utils</a></li><li><a class="tocitem" href="../../API/executors/">Executors</a></li><li><a class="tocitem" href="../../API/exchanges/">Exchanges</a></li><li><a class="tocitem" href="../../API/fetch/">Fetch module</a></li><li><a class="tocitem" href="../../API/engine/">Engine</a></li><li><a class="tocitem" href="../../API/instances/">Instances</a></li><li><a class="tocitem" href="../../API/instruments/">Instruments</a></li><li><a class="tocitem" href="../../API/misc/">Misc</a></li><li><a class="tocitem" href="../../API/optimization/">Optimization</a></li><li><a class="tocitem" href="../../API/pbar/">Pbar</a></li><li><a class="tocitem" href="../../API/plotting/">Plotting</a></li><li><a class="tocitem" href="../../API/prices/">Prices</a></li><li><a class="tocitem" href="../../API/processing/">Processing</a></li><li><a class="tocitem" href="../../API/python/">Python</a></li><li><a class="tocitem" href="../../API/stats/">Stats</a></li><li><a class="tocitem" href="../../API/strategies/">Strategies</a></li><li><input class="collapse-toggle" id="menuitem-13-20" type="checkbox"/><label class="tocitem" for="menuitem-13-20"><span class="docs-label">Analysis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/analysis/analysis/">Analysis</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Engine</a></li><li class="is-active"><a href>Backtesting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Backtesting</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/panifie/PingPong.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/panifie/PingPong.jl/blob/master/docs/src/engine/backtesting.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Running-a-Backtest"><a class="docs-heading-anchor" href="#Running-a-Backtest">Running a Backtest</a><a id="Running-a-Backtest-1"></a><a class="docs-heading-anchor-permalink" href="#Running-a-Backtest" title="Permalink"></a></h1><p>To perform a backtest, you need to construct a strategy by following the guidelines in the <a href="../../strategy/">Strategy Documentation</a>. Once the strategy is created, you can call the <code>start!</code> function on it to begin the backtest.</p><p>The entry function that is called in all modes is <code>ping!(s::Strategy, ts::DateTime, ctx)</code>. This function takes three arguments:</p><ul><li><code>s</code>: The strategy object that you have created.</li><li><code>ts</code>: The current date. In live mode, it is very close to <code>now()</code>, while in simulation mode, it is the date of the iteration step.</li><li><code>ctx</code>: Additional context information that can be passed to the function.</li></ul><p>During the backtest, the <code>ping!</code> function is responsible for executing the strategy&#39;s logic at each timestep. It is called repeatedly with updated values of <code>ts</code> until the backtest is complete.</p><p>It is important to note that the <code>ping!</code> function should be implemented in your strategy module according to your specific trading logic.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>Here is an example of how to use the <code>ping!</code> function in a strategy module:</p><pre><code class="language-julia hljs">module ExampleStrategy

# Define the ping! function
ping!(s::Strategy, ts::DateTime, ctx) = begin
    # Insert your trading logic here
end

end</code></pre><p>Let&#39;s run a backtest.</p><pre><code class="language-julia hljs">using Engine.Strategies
using Engine.Executors: SimMode as sm
s = strategy(:Example)
# Load data in the strategy universe (you need to already have it)
fill!(s) # or stub!(s.universe, datadict)
# backtest the strategy within the period available from the loaded data.
sm.start!(s)
# Lets see how we fared:
display(s)
## output
Name: Example
Config: 10.0(USDT)(Base Size), 100.0(USDT)(Initial Cash)
Universe: 3 instances, 1 exchanges
Holdings: assets(trades): 2(977), min BTC: 23.13(USDT), max XMR: 79.611(USDT)
Pending buys: 3
Pending sells: 0
USDT: 32.593 (Cash)
USDT: 156.455 (Total)</code></pre><p>Our backtest indicates that our strategy:</p><ul><li>Operated on <strong>3 assets</strong> (instances)</li><li>Executed <strong>977 trades</strong></li><li>Started with <strong>100 USDT</strong> and finished with <strong>32 USDT</strong> in cash, and assets worth <strong>156 USDT</strong></li><li>The asset with the minimum value at the end was <strong>BTC</strong>, and the one with the maximum value was <strong>XMR</strong></li><li>At the end, there were <strong>3 open buy orders</strong> and <strong>no open sell orders</strong>.</li></ul><h1 id="Orders"><a class="docs-heading-anchor" href="#Orders">Orders</a><a id="Orders-1"></a><a class="docs-heading-anchor-permalink" href="#Orders" title="Permalink"></a></h1><p>To place a limit order within your strategy, you call <code>pong!</code> just like any call to the executor. Here are the arguments:</p><pre><code class="language-julia hljs">trade = pong!(s, GTCOrder{Buy}, ai; price, amount, date=ts)</code></pre><p>Where <code>s</code> is your <code>Strategy{Sim, ...}</code> instance, <code>ai</code> is the <code>AssetInstance</code> to which the order refers (it should be one present in your <code>s.universe</code>). The <code>amount</code> is the quantity in base currency and <code>date</code> should be the one fed to the <code>ping!</code> function. During backtesting, this would be the current timestamp being evaluated, and during live trading, it would be a recent timestamp. If you look at the example strategy, <code>ts</code> is <em>current</em> and <code>ats</code> is <em>available</em>. The available timestamp <code>ats</code> is the one that matches the last candle that doesn&#39;t give you forward knowledge. The <code>date</code> given to the order call (<code>pong!</code>) must always be the <em>current</em> timestamp.</p><p>A limit order call might return a trade if the order was queued correctly. If the trade hasn&#39;t completed the order, the order is queued in <code>s.buy/sellorders[ai]</code>. If <code>isnothing(trade)</code> is <code>true</code>, it means the order failed and was not scheduled. This can happen if the cost of the trade did not meet the asset limits, or there wasn&#39;t enough commitable cash. If instead <code>ismissing(trade)</code> is <code>true</code>, it means that the order was scheduled, but no trade has yet been performed. In backtesting, this happens if the price of the order is too low (buy) or too high (sell) for the current candle high/low prices.</p><h2 id="Limit-Order-Types"><a class="docs-heading-anchor" href="#Limit-Order-Types">Limit Order Types</a><a id="Limit-Order-Types-1"></a><a class="docs-heading-anchor-permalink" href="#Limit-Order-Types" title="Permalink"></a></h2><p>In addition to GTC (Good Till Canceled) orders, there are also IOC (Immediate Or Cancel) and FOK (Fill Or Kill) orders:</p><ul><li>GTC: This order remains active until it is either filled or canceled.</li><li>IOC: This order must be executed immediately. Any portion of the order that cannot be filled immediately will be canceled.</li><li>FOK: This order must be executed in its entirety or not at all.</li></ul><p>All three are subtypes of a limit order, <code>&lt;: LimitOrder&gt;</code>. You can create them by calling <code>pong!</code> as shown below:</p><pre><code class="language-julia hljs">trade = pong!(s, IOCOrder{Buy}, ai; price, amount, date=ts)
trade = pong!(s, FOKOrder{Sell}, ai; price, amount, date=ts)</code></pre><h2 id="Market-Order-Types"><a class="docs-heading-anchor" href="#Market-Order-Types">Market Order Types</a><a id="Market-Order-Types-1"></a><a class="docs-heading-anchor-permalink" href="#Market-Order-Types" title="Permalink"></a></h2><p>Market order types include:</p><ul><li>MarketOrder: This order is executed at the best available price in the market.</li><li>LiquidationOrder: This order is similar to a MarketOrder, but its execution price might differ from the candle price.</li><li>ReduceOnlyOrder: This is a market order that is automatically triggered when manually closing a position.</li></ul><p>All of these behave in the same way, except for the LiquidationOrder. For example, a ReduceOnlyOrder is triggered when manually closing a position, as shown below:</p><pre><code class="language-julia hljs">pong!(s, ai, Long(), now(), PositionClose())</code></pre><h2 id="Market-Orders"><a class="docs-heading-anchor" href="#Market-Orders">Market Orders</a><a id="Market-Orders-1"></a><a class="docs-heading-anchor-permalink" href="#Market-Orders" title="Permalink"></a></h2><p>Although the ccxt library allows setting <code>timeInForce</code> for market orders because exchanges generally permit it, there isn&#39;t definitive information about how a market order is handled in these cases. Given that we are dealing with cryptocurrencies, some contexts like open and close times days are lost. It&#39;s plausible that <code>timeInForce</code> only matters when the order book doesn&#39;t have enough liquidity; otherwise, market orders are always <em>immediate</em> and <em>fully filled</em> orders. For this reason, we always consider market orders as FOK orders, and they will always have <code>timeInForce</code> set to FOK when executed live (through ccxt) to match the backtester.</p><div class="admonition is-warning"><header class="admonition-header">Market orders can be surprising</header><div class="admonition-body"><p>Market orders <em>always</em> go through in the backtest. If the candle has no volume, the order incurs in <em>heavy</em> slippage, and the execution price of the trades <em>can</em> exceed the candle high/low price.</p></div></div><h2 id="Checks"><a class="docs-heading-anchor" href="#Checks">Checks</a><a id="Checks-1"></a><a class="docs-heading-anchor-permalink" href="#Checks" title="Permalink"></a></h2><p>Before an order is created, several checks are performed to sanitize the values. For instance, if the specified amount is too small, the system will automatically adjust it to the minimum allowable amount. However, if there isn&#39;t sufficient cash after this adjustment, the order will fail. For more information on precision and limits, please refer to the <a href="http://docs.ccxt.com/#/?id=precision-and-limits">ccxt documentation</a>.</p><h2 id="Fees"><a class="docs-heading-anchor" href="#Fees">Fees</a><a id="Fees-1"></a><a class="docs-heading-anchor-permalink" href="#Fees" title="Permalink"></a></h2><p>The fees are derived from the <code>AssetInstance</code> <code>fees</code> property, which is populated by parsing the ccxt data for the specific symbol. Every trade takes these fees into account.</p><h2 id="Slippage"><a class="docs-heading-anchor" href="#Slippage">Slippage</a><a id="Slippage-1"></a><a class="docs-heading-anchor-permalink" href="#Slippage" title="Permalink"></a></h2><p>Slippage is factored into the trade execution process. Here&#39;s how it works for different types of orders:</p><ul><li><p><strong>Limit Orders</strong>: These can only experience positive slippage. When an order is placed and the price moves in your favor, the actual execution price becomes slightly lower (for buy orders) or higher (for sell orders). The slippage formula considers volatility (high/low) and fill ratio (amount/volume). The more volume the order takes from the candle, the lower the positive slippage will be. Conversely, higher volatility leads to higher positive slippage. Positive slippage is only added for candles that move against the order side, meaning it will only be added on red candles for buys, and green candles for sells.</p></li><li><p><strong>Market Orders</strong>: These can only experience negative slippage. There is always a minimum slippage added, which by default corresponds to the difference between open and close prices (other formulas are available, check the API reference). On top of this, additional skew is added based on volume and volatility.</p></li></ul><h2 id="Liquidations"><a class="docs-heading-anchor" href="#Liquidations">Liquidations</a><a id="Liquidations-1"></a><a class="docs-heading-anchor-permalink" href="#Liquidations" title="Permalink"></a></h2><p>In isolated margin mode, liquidations are triggered by checking the <code>LIQUIDATION_BUFFER</code>. You can customize the buffer size by setting the value of the environment variable <code>PINGONG_LIQUIDATION_BUFFER</code>. This allows you to adjust the threshold at which liquidations are triggered.</p><p>To obtain more accurate estimations, you can utilize the effective funding rate. This can be done by downloading the funding rate history using the <code>Fetch</code> module. By analyzing the funding rate history, you can gain insights into the funding costs associated with trading in isolated margin mode.</p><h2 id="Backtesting-Performance"><a class="docs-heading-anchor" href="#Backtesting-Performance">Backtesting Performance</a><a id="Backtesting-Performance-1"></a><a class="docs-heading-anchor-permalink" href="#Backtesting-Performance" title="Permalink"></a></h2><p>Local benchmarking indicates that the <code>:Example</code> strategy, which employs FOK orders, operates on three assets, trades in spot markets, and utilizes a simple logic (which can be reviewed in the strategy code) to execute orders, currently takes approximately <code>~8 seconds</code> to cycle through <code>~1.3M * 3 (assets) ~= 3.9M candles</code>, executing <code>~6000 trades</code> on a single x86 core.</p><p>It&#39;s crucial to note that the type of orders executed and the number of trades performed can significantly impact the runtime, aside from other evident factors like additional strategy logic or the number of assets. Therefore, caution is advised when interpreting claims about a backtester&#39;s ability to process X rows in Y time without additional context. Furthermore, our order creation logic always ensures that order inputs adhere to the exchange&#39;s <a href="https://docs.ccxt.com/#/README?id=precision-and-limits">limits</a>, and we also incorporate slippage and probability calculations, enabling the backtester to be &quot;MC simmable&quot;.</p><p>Backtesting a strategy with margin will inevitably be slower due to the need to account for all the necessary calculations, such as position states and liquidation triggers.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../engine/">« Executors</a><a class="docs-footer-nextpage" href="../paper/">Paper »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Monday 24 June 2024 15:12">Monday 24 June 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
